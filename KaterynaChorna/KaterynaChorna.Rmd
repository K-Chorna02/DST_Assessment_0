---
title: "Using Global City Air Quality Data "
author: "Kateryna Chorna"
output:
  html_document:
    toc: true
    theme: united
    number_sections: true
---


# Overview

Using global city air quality data from WHO, in this report I:

-   Explore correlations between PM2.5, PM10, and NO₂.\
-   Investigate how data coverage affects these correlations.\
-   Explore trends in pollutant levels over time.
-   Investigate how data coverage affects these trends.

## Requirements

The following solution checks for the requirements, and then installs them if they are not present.

```{r}
# --- 0. Install and load libraries ---
if(!require("gplots")) install.packages("gplots")
if(!require("readr")) install.packages("readr")
if(!require("readxl")) install.packages("readxl")
if(!require("dplyr")) install.packages("dplyr")
if(!require("ggplot2")) install.packages("ggplot2")
if(!require("kableExtra")) install.packages("kableExtra")

library(gplots)
library(readr)
library(readxl)
library(dplyr)
library(ggplot2)
library(kableExtra)

```

```{r}
# read sheet 3 of the Excel file

getwd()
data <- read_excel("../data/who_air_quality_2024.xlsx", sheet = 3)
```
# Exploratory Data Analysis
We get a summary of the data. Some data should be numeric, but it's not read as numeric by R. So we convert some numeric-like columns stored as character to numeric.

```{r}
#Replace literal "NA" strings with proper R NA ---
data[data == "NA"] <- NA

#convert numeric-like columns stored as character to numeric ---
num_cols <- c("pm10_concentration","pm25_concentration","no2_concentration",
              "pm10_tempcov","pm25_tempcov","no2_tempcov","population")

data[num_cols] <- lapply(data[num_cols], as.numeric) # set the data as numeric

summary(data)
```

## Correlation between PM2.5, PM10, and NO₂

```{r}
corr_matrix <- cor(data[, c("pm25_concentration","pm10_concentration","no2_concentration")],
                   use="complete.obs")
corr_matrix
```

```{r}
```

PM2.5 and PM10 are strongly positively correlated (0.91). So, cities with higher PM10 usually also have higher PM2.5

```{r}
pairs(data[, c("pm25_concentration","pm10_concentration","no2_concentration")],
      main="Pollutant Correlations")
```

We look at Temporal Coverage of Pollutants to check how complete the annual monitoring is for each pollutant.

```{r}

# Summary stats
summary(data[, c("pm25_tempcov","pm10_tempcov","no2_tempcov")], na.rm = TRUE)


# Filter cities with at least 75% coverage
data_highcov <- subset(data,
                        pm25_tempcov >= 75 & 
                        pm10_tempcov >= 75 & 
                        no2_tempcov >= 75)

nrow(data_highcov)  # number of cities remaining

# Correlation matrix for high-coverage cities
corr_matrix_highcov <- cor(data_highcov[, c("pm25_concentration",
                                            "pm10_concentration",
                                            "no2_concentration")],
                           use = "complete.obs")
corr_matrix_highcov

# Scatterplot matrix for high-coverage cities
pairs(data_highcov[, c("pm25_concentration","pm10_concentration","no2_concentration")],
      main="Pollutant Correlations (High-Coverage Cities)")

```

After restricting to cities with at least 75% annual coverage, PM2.5 and PM10 remain strongly positively correlated (r ≈ 0.82). Correlations with NO₂ are moderate (\~0.43). The slight reduction in correlation reflects the removal of extreme values, making these estimates more reliable.

## Trends Over Time

We calculate the average concentration per year for PM2.5, PM10, and NO2 using all available data. This shows overall trends in air quality over time and lets us compare pollutants. Averages ignore missing values, so each year reflects the data that’s actually recorded.

```{r}
trend_data <- data %>%
  group_by(year) %>%
  summarise(mean_pm25 = mean(pm25_concentration, na.rm = TRUE),
            mean_pm10 = mean(pm10_concentration, na.rm = TRUE),
            mean_no2  = mean(no2_concentration, na.rm = TRUE))

ggplot(trend_data, aes(x = as.integer(year))) +
  geom_line(aes(y = mean_pm10, colour = "PM10"), size = 1) +
  geom_line(aes(y = mean_no2,  colour = "NO2"), size = 1) +
  geom_line(aes(y = mean_pm25, colour = "PM2.5"), size = 1) +
  scale_colour_manual(values = c("PM10" = "blue",
                                 "NO2"  = "green",
                                 "PM2.5" = "red")) +
  scale_x_continuous(breaks = unique(trend_data$year)) +
  labs(title = "Global Trends in Air Pollutant Levels Over Time",
       y = "Average Concentration (µg/m³)", x = "Year",
       colour = "Pollutant") +
  theme_minimal()


```

We get some warnings when plotting because a few rows have missing or invalid values for the year or pollutant. There are also noticeable spikes in PM10 for certain years, due to missing data and outliers. For example, some years might have only a few days recorded or only some pollutants measured.

To get a clearer picture, we focus on rows where all three pollutants are recorded. This removes missing values and lets us calculate yearly averages more reliably. Comparing this complete data subset with the full dataset shows whether the overall trends are consistent or affected by missing data.

```{r}
# Trends Over Time (Complete Data )
# Complete data (all three pollutants recorded)
data_complete <- data[complete.cases(data[, c("pm25_concentration","pm10_concentration","no2_concentration")]), ]


trend_data_complete <- data_complete %>%
  group_by(year) %>%
  summarise(mean_pm25 = mean(pm25_concentration, na.rm = TRUE),
            mean_pm10 = mean(pm10_concentration, na.rm = TRUE),
            mean_no2  = mean(no2_concentration, na.rm = TRUE))

ggplot(trend_data_complete, aes(x = as.integer(year))) +
  geom_line(aes(y = mean_pm10, colour = "PM10"), size = 1) +
  geom_line(aes(y = mean_no2,  colour = "NO2"), size = 1) +
  geom_line(aes(y = mean_pm25, colour = "PM2.5"), size = 1) +
  scale_colour_manual(values = c("PM10" = "blue",
                                 "NO2"  = "green",
                                 "PM2.5" = "red")) +
  scale_x_continuous(breaks = unique(trend_data_complete$year)) +
  labs(title = "Global Trends in Air Pollutant Levels Over Time (Complete Data)",
       y = "Average Concentration (µg/m³)", x = "Year",
       colour = "Pollutant") +
  theme_minimal()



```

Now all concentrations are between 10 and 35, so the range is smaller. In this filtered data, PM10 is always the highest, followed by NO₂, and then PM2.5. This ordering is clearer because extreme values and missing data have been removed.

```{r}
# Total rows
n_all <- nrow(data)
n_all

# Complete data (all three pollutants recorded)
data_complete <- data[complete.cases(data[, c("pm25_concentration","pm10_concentration","no2_concentration")]), ]
n_complete <- nrow(data_complete)
n_complete

# Complete data + high coverage (≥75% for all pollutants)
data_highcov_complete <- data_complete %>%
  filter(!is.na(pm25_tempcov), !is.na(pm10_tempcov), !is.na(no2_tempcov),
         pm25_tempcov >= 75, pm10_tempcov >= 75, no2_tempcov >= 75)

n_highcov_complete <- nrow(data_highcov_complete)
n_highcov_complete

```

We can also remove low-coverage data, keeping only cities with at least 75% annual coverage,but reduces the dataset from 40,098 rows to 7,563.

```{r}
trend_highcov_complete <- data_highcov_complete %>%
  group_by(year) %>%
  summarise(mean_pm25 = mean(pm25_concentration, na.rm = TRUE),
            mean_pm10 = mean(pm10_concentration, na.rm = TRUE),
            mean_no2  = mean(no2_concentration, na.rm = TRUE))

ggplot(trend_highcov_complete, aes(x = as.integer(year))) +
  geom_line(aes(y = mean_pm25, colour = "PM2.5"), size = 1) +
  geom_line(aes(y = mean_pm10, colour = "PM10"), size = 1) +
  geom_line(aes(y = mean_no2,  colour = "NO2"), size = 1) +
  scale_colour_manual(values = c("PM2.5" = "red",
                                 "PM10"  = "blue",
                                 "NO2"   = "green")) +
  scale_x_continuous(breaks = unique(trend_highcov_complete$year)) +
  labs(title = "Global Trends in Air Pollutant Levels Over Time\n(Complete + High Coverage Data)",
       y = "Average Concentration (µg/m³)", x = "Year",
       colour = "Pollutant") +
  theme_minimal()

```

However, for 2010–2013 the pollution shows noticeable spikes, so we need to check how much data we actually have for those years. Filtering for high coverage makes the trends less reliable there. After 2013 the trends are smoother, and we can clearly see that PM10 is always the highest, followed by NO₂, then PM2.5, with all pollutants generally decreasing

```{r}
summary_table <- data_highcov_complete %>%
  group_by(year) %>%
  summarise(n = n(),
            mean_pm25 = mean(pm25_concentration, na.rm = TRUE),
            mean_pm10 = mean(pm10_concentration, na.rm = TRUE),
            mean_no2  = mean(no2_concentration, na.rm = TRUE)) %>%
  arrange(year)
kable(summary_table,
      digits = 2, 
      col.names = c("Year", "Observations", "PM2.5 (µg/m³)", "PM10 (µg/m³)", "NO2 (µg/m³)"),
      caption = "") %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover", "condensed"))

```

For years 2011 and 2012, there are only 1–2 records available. This makes the average concentrations for those years highly unreliable.

## Coverage by region

Now we look at how data coverage is spread across regions. This shows where the high-coverage data comes from, where coverage is low, and where it’s missing. It also helps us see which regions are well represented and which aren’t, so we know the limits of what we can analyse.

```{r}
# Classify each city by coverage
data <- data %>%
  mutate(coverage_category = case_when(
    is.na(pm25_tempcov) & is.na(pm10_tempcov) & is.na(no2_tempcov) ~ "NA",
    pm25_tempcov >= 75 & pm10_tempcov >= 75 & no2_tempcov >= 75 ~ "High",
    TRUE ~ "Low"
  ))

# Summarise by region
coverage_by_region <- data %>%
  group_by(who_region, coverage_category) %>%
  summarise(n_cities = n_distinct(city), .groups = "drop")

# Plot stacked bar chart
ggplot(coverage_by_region, aes(x = who_region, y = n_cities, fill = coverage_category)) +
  geom_bar(stat = "identity") +
  labs(title = "Air Quality Data Coverage by Region",
       x = "Region", y = "Number of Cities", fill = "Coverage") +
  theme_minimal()
```

Most high-coverage cities are in Europe, with some in Southeast Asia and North America. This means the trends from high-coverage data mainly reflect European cities and aren’t representative of global air quality. Regions like Africa and the Eastern Mediterranean have very little data, so we can’t draw any conclusions there.

# Conclusion 
In this report, we explored global city air quality data from WHO. PM2.5 and PM10 are strongly correlated, while NO₂ shows a moderate correlation with both. Limiting data to cities with over 75% coverage doesn’t change these correlations much, but it removes outliers and reduces the dataset, making some early years, like 2010–2012, unreliable due to very few records and noticeable spikes. After 2013, pollutant levels show a steady decrease, with PM10 consistently the highest, followed by NO₂ and PM2.5. Coverage is uneven across regions and most high-coverage data comes from Europe, with some from North America, while Africa and the Eastern Mediterranean are greatly underrepresented. This means the trends mainly reflect well-covered regions like Europe, where pollution is decreasing due to legislation and other measures, but these patterns may not represent global trends.
