---
title: "Ambient air quality, WHO--  EDA"
output: html_document
date: "2025-10-01"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
library(ggplot2)
library(dplyr)
```

some things could explore-

- which cities have highest average AQI
- average level of year pollutant per year
-city /  country with cleanest air on average - could look at general trend here, are they more/less developed?- this knowledge of the countries would this be considered expert knowledge


looking at population specifically:
how does air quality change as population increases,are different pollutants different in different pop sizes.


lets look at the dataset and clean the data set for each column: pm10_concentration, pm25_concentration, no2_concentration, population.
```{r}
library(readxl)  # load the package

dataset <- read_excel("who_data.xlsx")

dataset


dataset[dataset == "NA"] <- NA


clean_data_pm10 <- dataset[!is.na(dataset$pm10_concentration), ] %>%
  mutate(across(c(no2_concentration, pm25_concentration, pm10_concentration, population),
                as.numeric))
clean_data_pm25 <- dataset[!is.na(dataset$pm25_concentration), ] %>%
  mutate(across(c(no2_concentration, pm25_concentration, pm10_concentration, population),
                as.numeric))
clean_data_no2 <- dataset[!is.na(dataset$no2_concentration), ] %>%
  mutate(across(c(no2_concentration, pm25_concentration, pm10_concentration, population),
                as.numeric))
clean_data_pop <- dataset[!is.na(dataset$population), ] %>%
  mutate(across(c(no2_concentration, pm25_concentration, pm10_concentration, population),
                as.numeric))

clean_data_all <- dataset[
  !is.na(dataset$population) &
  !is.na(dataset$no2_concentration) &
  !is.na(dataset$pm25_concentration) &
  !is.na(dataset$pm10_concentration),
] %>%
  mutate(across(c(no2_concentration, pm25_concentration, pm10_concentration, population),
                as.numeric))

# lets also clean the data for one concentration and population so we will have more data points when we visulise the data in the graph

clean_data_pm10_pop <- dataset[
  !is.na(dataset$population) &
  !is.na(dataset$pm10_concentration),
] %>%
  mutate(across(c(no2_concentration, pm25_concentration, pm10_concentration, population),
                as.numeric))

clean_data_pm25_pop <- dataset[
  !is.na(dataset$population) &
  !is.na(dataset$pm25_concentration),
] %>%
  mutate(across(c(no2_concentration, pm25_concentration, pm10_concentration, population),
                as.numeric))

clean_data_no2_pop <- dataset[
  !is.na(dataset$population) &
  !is.na(dataset$no2_concentration),
] %>%
  mutate(across(c(no2_concentration, pm25_concentration, pm10_concentration, population),
                as.numeric))

```

lets calculate some average values of columns
 
```{r}
mean(clean_data_pm10$pm10_concentration)
mean(clean_data_pm25$pm25_concentration)
mean(clean_data_no2$no2_concentration)
mean(clean_data_pop$population)


#see how the averages change when we use the cleaned data for all the columns- so here we have much less data.
mean(clean_data_all$pm10_concentration)
mean(clean_data_all$pm25_concentration)
mean(clean_data_all$no2_concentration)
mean(clean_data_all$population)
```


for the first bit of analysis lets use the fully cleaned data.
```{r}
ggplot(data=clean_data_all, aes(x = population, y = pm10_concentration, colour = year)) + geom_point()
ggplot(data=clean_data_all, aes(x = population, y = pm25_concentration, colour = year)) + geom_point()
ggplot(data =clean_data_all, aes(x = population, y = no2_concentration, colour = year)) + geom_point()
```
cant really see much of a trend here. this might be because we have such a spread in the size of the populations, perhaps taking the log of the population will help see the trend



```{r}
ggplot(data=clean_data_all, aes(x = population, y = pm10_concentration, colour = year)) + geom_point() + scale_x_log10() + geom_smooth(method = 'loess', color = 'red')
ggplot(data=clean_data_all, aes(x = population, y = pm25_concentration, colour = year)) + geom_point() + scale_x_log10() + geom_smooth(method = 'loess', color = 'red')
ggplot(data =clean_data_all, aes(x = population, y = no2_concentration, colour = year)) + geom_point() + scale_x_log10() + geom_smooth(method = 'loess', color = 'red')
```
this has helped us visualise the trend, 


lets compare these two models
```{r}
# Linear model (no transformation)
model1 <- lm(pm25_concentration ~ population, data = clean_data_all)

# Log-transformed model
model_log <- lm(pm25_concentration ~ log10(population), data = clean_data_all)

summary(model1)
summary(model_log)

```

R^2 is lower for log model which suggests its actually a worse model which is the opposite of what we thoght when looking at the graphs.
```{r}
# Linear model (no transformation)
model2 <- lm(pm10_concentration ~ population, data = clean_data_all)

# Log-transformed model
model2_log <- lm(pm10_concentration ~ log10(population), data = clean_data_all)

summary(model2)
summary(model2_log)

# Linear model (no transformation)
model3 <- lm(no2_concentration ~ population, data = clean_data_all)

# Log-transformed model
model3_log <- lm(no2_concentration ~ log10(population), data = clean_data_all)

summary(model3)
summary(model3_log)


```
for NO2 con and pm10 concentration the R^2 is higher for the log model suggesting the log relationship is a better model, this is what we expected from looking at the two different graphs


lets take a look at just the data in a specific year.







```{r}

clean_data_pm10_pop_2021 <- clean_data_pm10_pop %>% filter(year == '2021')


ggplot(clean_data_pm10_pop_2021, aes(x = population, y= pm10_concentration)) + geom_point()

ggplot(clean_data_pm10_pop_2021, aes(x = population, y= pm10_concentration)) + geom_point() + scale_x_log10() + geom_smooth( method = 'loess' , color = 'red' )

##


clean_data_pm25_pop_2021 <- clean_data_pm25_pop %>% filter(year == '2021')


ggplot(clean_data_pm25_pop_2021, aes(x = population, y= pm25_concentration)) + geom_point()

ggplot(clean_data_pm25_pop_2021, aes(x = population, y= pm25_concentration)) + geom_point() + scale_x_log10() + geom_smooth( method = 'loess' , color = 'red' )



clean_data_no2_pop_2021 <- clean_data_no2_pop %>% filter(year == '2021')


ggplot(clean_data_no2_pop_2021, aes(x = population, y= no2_concentration)) + geom_point()

ggplot(clean_data_no2_pop_2021, aes(x = population, y= no2_concentration)) + geom_point() + scale_x_log10() + geom_smooth( method = 'loess' , color = 'red' )

```

Now we only have the concentrations for a specific year the trend here doesnt appear to be as obvious.


adding the concentration to a world map
```{r}

library(sf)
library(rnaturalearth)
library(rnaturalearthdata)

```

```{r}
# Get world map polygons
world <- ne_countries(scale = "medium", returnclass = "sf")

# Calculate average PM10 per country for 2021
country_avg_pm10_2021 <- clean_data_pm10 %>%
  filter(year == 2021) %>%
  group_by(iso3) %>%
  summarise(pm10_concentration = mean(pm10_concentration, na.rm = TRUE))

map_data_2021_pm10 <- world %>%
  left_join(country_avg_pm10_2021, by = c("iso_a3" = "iso3"))

ggplot(data = map_data_2021_pm10) +
  geom_sf(aes(fill = pm10_concentration)) +
  scale_fill_viridis_c(option = "plasma", na.value = "grey90") +
  theme_minimal() +
  labs(fill = "PM10 (µg/m³)",
       title = "Average PM10 Concentration by Country (2021)")
####

country_avg_pm25_2021 <- clean_data_pm25 %>%
  filter(year == 2021) %>%
  group_by(iso3) %>%
  summarise(pm25_concentration = mean(pm25_concentration, na.rm = TRUE))

map_data_2021_pm25 <- world %>%
  left_join(country_avg_pm25_2021, by = c("iso_a3" = "iso3"))

ggplot(data = map_data_2021_pm25) +
  geom_sf(aes(fill = pm25_concentration)) +
  scale_fill_viridis_c(option = "plasma", na.value = "grey90") +
  theme_minimal() +
  labs(fill = "PM25 (µg/m³)",
       title = "Average PM25 Concentration by Country (2021)")



```





not the best way to visulise the data as we have a lot of unfilled countries, looking at another year to check.



```{r}

# Calculate average PM10 per country for 2019
country_avg_pm10_2019 <- clean_data_pm10 %>%
  filter(year == 2019) %>%
  group_by(iso3) %>%
  summarise(pm10_concentration = mean(pm10_concentration, na.rm = TRUE))

map_data_2019_pm10 <- world %>%
  left_join(country_avg_pm10_2019, by = c("iso_a3" = "iso3"))

ggplot(data = map_data_2019_pm10) +
  geom_sf(aes(fill = pm10_concentration)) +
  scale_fill_viridis_c(option = "plasma", na.value = "grey90") +
  theme_minimal() +
  labs(fill = "PM10 (µg/m³)",
       title = "Average PM10 Concentration by Country (2019)")
####

country_avg_pm25_2019 <- clean_data_pm25 %>%
  filter(year == 2019) %>%
  group_by(iso3) %>%
  summarise(pm25_concentration = mean(pm25_concentration, na.rm = TRUE))

map_data_2019_pm25 <- world %>%
  left_join(country_avg_pm25_2019, by = c("iso_a3" = "iso3"))

ggplot(data = map_data_2019_pm25) +
  geom_sf(aes(fill = pm25_concentration)) +
  scale_fill_viridis_c(option = "plasma", na.value = "grey90") +
  theme_minimal() +
  labs(fill = "PM25 (µg/m³)",
       title = "Average PM25 Concentration by Country (2019)")


```


