---
title: "Ambient air quality, WHO--  EDA"
output: html_document
date: "2025-10-01"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Ambient Air quality dataset - EDA - Population size

```{r}
if(!require("ggplot2")) install.packages("ggplot2")
if(!require("dplyr")) install.packages("dplyr")
if(!require("readxl")) install.packages("readxl")
if(!require("tibble")) install.packages("tibble")
if(!require("sf")) install.packages("sf")
if(!require("rnaturalearth")) install.packages("rnaturalearth")
if(!require("rnaturalearthdata")) install.packages("rnaturalearthdata")

library(ggplot2)
library(dplyr)
library(readxl)
```

## Introduction 
Some initial thoughts on what we can look at throughout this project specifically on population

- how does air quality change as population increases
- are different pollutants different in different pop sizes.- in diff pop brackets what is the average con for each pollutant.

## Cleaning the Dataset
lets look at the dataset
```{r}
dataset <- read_excel("who_data.xlsx")
dataset
```

Some definitions of our dataset that we are using.

pm10_concentration - Annual mean concentration of particulate matter with diameter of 10 μm or less (µg/m3)
pm25_concentration - Annual mean concentration of particulate matter with diameter of 2.5μm or less (µg/m3)
no2_concentration - Annual mean concentration of nitrogen dioxide (µg/m3)




As we can see from looking at the dataset, lots of the rows we have some missing values. So we will clean the data set for each column: pm10_concentration, pm25_concentration, no2_concentration, population as well as all of these at once since when we do this we will have less data points to analyse - this will be something to think about later: do we clean the whole data or just for specific columns?
```{r}
dataset[dataset == "NA"] <- NA

# cleaning the data for specific columns and making the values numbers instead of characters which they currently are.
clean_data_pm10 <- dataset[!is.na(dataset$pm10_concentration), ] %>%
  mutate(across(c(no2_concentration, pm25_concentration, pm10_concentration, population),
                as.numeric))
clean_data_pm25 <- dataset[!is.na(dataset$pm25_concentration), ] %>%
  mutate(across(c(no2_concentration, pm25_concentration, pm10_concentration, population),
                as.numeric))
clean_data_no2 <- dataset[!is.na(dataset$no2_concentration), ] %>%
  mutate(across(c(no2_concentration, pm25_concentration, pm10_concentration, population),
                as.numeric))
clean_data_pop <- dataset[!is.na(dataset$population), ] %>%
  mutate(across(c(no2_concentration, pm25_concentration, pm10_concentration, population),
                as.numeric))
# cleaning every column we are using
clean_data_all <- dataset[
  !is.na(dataset$population) &
  !is.na(dataset$no2_concentration) &
  !is.na(dataset$pm25_concentration) &
  !is.na(dataset$pm10_concentration),
] %>%
  mutate(across(c(no2_concentration, pm25_concentration, pm10_concentration, population),
                as.numeric))

# lets also clean the data for one concentration and population so we will have more data points when we visualise the data in the graph

clean_data_pm10_pop <- dataset[
  !is.na(dataset$population) &
  !is.na(dataset$pm10_concentration),
] %>%
  mutate(across(c(no2_concentration, pm25_concentration, pm10_concentration, population),
                as.numeric))

clean_data_pm25_pop <- dataset[
  !is.na(dataset$population) &
  !is.na(dataset$pm25_concentration),
] %>%
  mutate(across(c(no2_concentration, pm25_concentration, pm10_concentration, population),
                as.numeric))

clean_data_no2_pop <- dataset[
  !is.na(dataset$population) &
  !is.na(dataset$no2_concentration),
] %>%
  mutate(across(c(no2_concentration, pm25_concentration, pm10_concentration, population),
                as.numeric))
```

lets calculate some average values of columns

```{r}
library(tibble)

comparison_table <- tibble(
  Dataset = c("PM10 Cleaned", "PM2.5 Cleaned", "NO2 Cleaned", "Population Cleaned",
              "All Cleaned (PM10, PM2.5, NO2, Pop)"),
  Mean_PM10 = c(mean(clean_data_pm10$pm10_concentration, na.rm = TRUE),
                NA, NA,
                NA,
                mean(clean_data_all$pm10_concentration, na.rm = TRUE)),
  Mean_PM25 = c(NA,
                mean(clean_data_pm25$pm25_concentration, na.rm = TRUE),
                NA,
                NA,
                mean(clean_data_all$pm25_concentration, na.rm = TRUE)),
  Mean_NO2 = c(NA, NA,
               mean(clean_data_no2$no2_concentration, na.rm = TRUE),
               NA,
               mean(clean_data_all$no2_concentration, na.rm = TRUE)),
  Mean_Population = c(NA, NA, NA,
                      mean(clean_data_pop$population, na.rm = TRUE),
                      mean(clean_data_all$population, na.rm = TRUE))
)

comparison_table

```
This table has highlighted how much some of our averages change when we take different versions of the cleaned data, the values are still similar for pm10 concentration but we see quite a big different for pm25 and no2 concentration.

```{r}
summary(clean_data_all$population)
```



To see how the concentration of pollutants changes for different populations we turn the population into a categorical variable making different population brackets. We have set the population brackets below based on the spread of the population provided by the summary above.


```{r}
dataset_popbrackets <- clean_data_all %>%
  mutate(pop_bracket = case_when( # create categorical groups, create a new column pop_bracket which assigns the population into the categorical sections
    population < 100000 ~ "<100K",
    population < 250000 ~ "100K–250K",
    population < 1000000 ~ "250K–1M",
    population < 5000000 ~ "1M–5M",
    TRUE ~ ">5M"
  ))


avg_con <- dataset_popbrackets %>%
  group_by(pop_bracket) %>%
  summarise(
    mean_pm25 = mean(pm25_concentration, na.rm = TRUE), # will calculate for each pop bracket 
    mean_pm10 = mean(pm10_concentration, na.rm = TRUE),
    mean_no2 = mean(no2_concentration, na.rm = TRUE)
  )


library(tidyr)
library(ggplot2)


avg_con_long <- avg_con %>%
  pivot_longer(cols = starts_with("mean_"), # changing data format
               names_to = "concentration",
               values_to = "avg_concentration") %>%
  mutate(concentration = recode(concentration,
                            "mean_pm25" = "PM2.5",
                            "mean_pm10" = "PM10",
                            "mean_no2" = "NO₂"),
         pop_bracket = factor(pop_bracket,
                              levels = c("<100K", "100K–250K", "250K–1M", "1M–5M", ">5M"))) #orders the x-axis numerically


ggplot(avg_con_long, aes(x = pop_bracket, y = avg_concentration, fill = concentration)) +
  geom_col(position = "dodge") +
  labs(title = "Average Pollutant Concentration by Population Bracket",
       x = "Population Bracket",
       y = "Average Concentration ",
       fill = "concentration") +
  theme_minimal()


```

So from the graph we can see that as the population size increases the average concentration of pollutant increases.


## Population vs Concentration Visulisation

Lets use the fully cleaned data.
```{r}
ggplot(data=clean_data_all, aes(x = population, y = pm10_concentration, colour = year)) + geom_point()
ggplot(data=clean_data_all, aes(x = population, y = pm25_concentration, colour = year)) + geom_point()
ggplot(data =clean_data_all, aes(x = population, y = no2_concentration, colour = year)) + geom_point()
```
We can't really see much of a trend here. This might be because we have such a spread in the size of the populations, perhaps taking the log of the population will help see the trend.



```{r}
ggplot(data=clean_data_all, aes(x = population, y = pm10_concentration, colour = year)) + geom_point() + scale_x_log10() + geom_smooth(method = 'loess', color = 'red') + geom_smooth(method = 'lm', color = 'green') 
ggplot(data=clean_data_all, aes(x = population, y = pm25_concentration, colour = year)) + geom_point() + scale_x_log10() + geom_smooth(method = 'loess', color = 'red') + geom_smooth(method = 'lm', color = 'green')
ggplot(data =clean_data_all, aes(x = population, y = no2_concentration, colour = year)) + geom_point() + scale_x_log10() + geom_smooth(method = 'loess', color = 'red') + geom_smooth(method = 'lm', color = 'green')
```
Now we can see a trend in the data- for all the concentrations as the population size increases the concentration increases. This is something we would have expected as a higher population would mean more waste and pollution and hence worse air quality.


lets compare these two models
```{r}
# Linear model - same as above
model1 <- lm(pm25_concentration ~ population, data = clean_data_all)

# Log-transformed model
model_log <- lm(pm25_concentration ~ log10(population), data = clean_data_all)

summary(model1)
summary(model_log)
```
Here $ R^2$ is lower for the log model which suggests its actually a worse model which is the opposite of what we thought when looking at the graphs.
For the next two models:
```{r}
# Linear model- same as above
model2 <- lm(pm10_concentration ~ population, data = clean_data_all)

# Log-transformed model
model2_log <- lm(pm10_concentration ~ log10(population), data = clean_data_all)

summary(model2)
summary(model2_log)

# Linear model - same as above
model3 <- lm(no2_concentration ~ population, data = clean_data_all)

# Log-transformed model
model3_log <- lm(no2_concentration ~ log10(population), data = clean_data_all)

summary(model3)
summary(model3_log)
```
for NO2 concentration and pm10 concentration the $ R^2$ is higher for the log model suggesting the log relationship is a better model, this is what we expected from looking at the two different graphs.


lets take a look at just the data in a specific year. Here we have used the cleaned data with only one concentration column cleaned and the population cleaned as otherwise we will have a lot less data points


```{r}
clean_data_pm10_pop_2021 <- clean_data_pm10_pop %>% filter(year == '2021')

ggplot(clean_data_pm10_pop_2021, aes(x = population, y= pm10_concentration)) + geom_point()

ggplot(clean_data_pm10_pop_2021, aes(x = population, y= pm10_concentration)) + geom_point() + scale_x_log10() + geom_smooth( method = 'loess' , color = 'red' )

##

clean_data_pm25_pop_2021 <- clean_data_pm25_pop %>% filter(year == '2021')

ggplot(clean_data_pm25_pop_2021, aes(x = population, y= pm25_concentration)) + geom_point()

ggplot(clean_data_pm25_pop_2021, aes(x = population, y= pm25_concentration)) + geom_point() + scale_x_log10() + geom_smooth( method = 'loess' , color = 'red' )

##

clean_data_no2_pop_2021 <- clean_data_no2_pop %>% filter(year == '2021')

ggplot(clean_data_no2_pop_2021, aes(x = population, y= no2_concentration)) + geom_point()

ggplot(clean_data_no2_pop_2021, aes(x = population, y= no2_concentration)) + geom_point() + scale_x_log10() + geom_smooth( method = 'loess' , color = 'red' )
```

Now we only have the concentrations for a specific year the trend here doesn't appear to be as obvious. We can see a trend in the no2 concentration similar to that previously.

## Visualising the concentration on a world map


```{r}
library(sf)
library(rnaturalearth)
library(rnaturalearthdata)
```

```{r}
# Get world map polygons
world <- ne_countries(scale = "medium", returnclass = "sf")

# Calculate average PM10 per country for 2021
country_avg_pm10_2021 <- clean_data_pm10 %>%
  filter(year == 2021) %>%
  group_by(iso3) %>%
  summarise(pm10_concentration = mean(pm10_concentration, na.rm = TRUE))

map_data_2021_pm10 <- world %>%
  left_join(country_avg_pm10_2021, by = c("iso_a3" = "iso3"))

ggplot(data = map_data_2021_pm10) +
  geom_sf(aes(fill = pm10_concentration)) +
  scale_fill_viridis_c(option = "plasma", na.value = "grey90") +
  theme_minimal() +
  labs(fill = "PM10",
       title = "Average PM10 Concentration by Country (2021)")
####

country_avg_pm25_2021 <- clean_data_pm25 %>%
  filter(year == 2021) %>%
  group_by(iso3) %>%
  summarise(pm25_concentration = mean(pm25_concentration, na.rm = TRUE))

map_data_2021_pm25 <- world %>%
  left_join(country_avg_pm25_2021, by = c("iso_a3" = "iso3"))

ggplot(data = map_data_2021_pm25) +
  geom_sf(aes(fill = pm25_concentration)) +
  scale_fill_viridis_c(option = "plasma", na.value = "grey90") +
  theme_minimal() +
  labs(fill = "PM25",
       title = "Average PM25 Concentration by Country (2021)")



```





not the best way to visualise the data as we have a lot of unfilled countries, looking at another year to check.



```{r}

# Calculate average PM10 per country for 2019
country_avg_pm10_2019 <- clean_data_pm10 %>%
  filter(year == 2019) %>%
  group_by(iso3) %>%
  summarise(pm10_concentration = mean(pm10_concentration, na.rm = TRUE))

map_data_2019_pm10 <- world %>%
  left_join(country_avg_pm10_2019, by = c("iso_a3" = "iso3"))

ggplot(data = map_data_2019_pm10) +
  geom_sf(aes(fill = pm10_concentration)) +
  scale_fill_viridis_c(option = "plasma", na.value = "grey90") +
  theme_minimal() +
  labs(fill = "PM10",
       title = "Average PM10 Concentration by Country (2019)")
####

country_avg_pm25_2019 <- clean_data_pm25 %>%
  filter(year == 2019) %>%
  group_by(iso3) %>%
  summarise(pm25_concentration = mean(pm25_concentration, na.rm = TRUE))

map_data_2019_pm25 <- world %>%
  left_join(country_avg_pm25_2019, by = c("iso_a3" = "iso3"))

ggplot(data = map_data_2019_pm25) +
  geom_sf(aes(fill = pm25_concentration)) +
  scale_fill_viridis_c(option = "plasma", na.value = "grey90") +
  theme_minimal() +
  labs(fill = "PM25",
       title = "Average PM25 Concentration by Country (2019)")

##
# Calculate average NO2 per country for 2019
country_avg_no2_2019 <- clean_data_no2 %>%
  filter(year == 2019) %>%
  group_by(iso3) %>%
  summarise(no2_concentration = mean(no2_concentration, na.rm = TRUE))

map_data_2019_no2 <- world %>%
  left_join(country_avg_no2_2019, by = c("iso_a3" = "iso3"))

ggplot(data = map_data_2019_no2) +
  geom_sf(aes(fill = no2_concentration)) +
  scale_fill_viridis_c(option = "plasma", na.value = "grey90") +
  theme_minimal() +
  labs(fill = "no2",
       title = "Average no2 Concentration by Country (2019)")
```
From the map of pm10 and pm25 concentrations in 2019 it appears that there are higher concentrations of particle matter in Asia.

