


---
title: "01-DataExploration- Air pollution modelling"
output:
  html_document: default
  pdf_document: default
  github_document: default
date: "2025-09-29"
---




```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)


library(readxl)
library(dplyr)
library(ggplot2)
library(here)

# Load the data 
air_data <- read.csv(here("data", "air_data.csv"), stringsAsFactors = FALSE)





```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r}
# View(air_data)

# head(air_data)

#str(air_data)

```

## Preforming linear regression

3 types of Pollution, so we are going to model 3 types of Y:
Y1 = pm25_concentration (particulate matter < 2.5µm)
Y2 = pm10_concentration (particulate matter < 10µm)
Y3 = no2_concentration (nitrogen dioxide)

at each time.

Looking at our dataset and what has already been analysed, some good candidates for covariates will could be:
- population (city size) - numeric, continiuos 
- year (to capture time effects) - numeric, discrete
- type of stations (urban, suburan, rural) - categorical 
- country - categorical (maybe by reigon)


 Our issue is that we have multiple labels in one row, eg "urban,suburan, suburan", so R would treat each string as a seperate "level", creating hundreds of basically meaningless factor levels


to keep things manageable, let us start with:

1. Population 
2. Year 


The general linear regression model can be written as:  

$$
Y_i = \beta_0 + \beta_1 \,\text{Population}_i + \beta_2 \,\text{Year}_i  + \varepsilon_i
$$

where $$\varepsilon_i \sim N(0, \sigma^2)$$ represents the error term.  


# before fitting we need make sure the data fits our categories, (eg, numeric, factors)
# we will try and work with types_stations and region later so we will clean it now 

```{r}

air_data$pm25_concentration <- as.numeric(air_data$pm25_concentration)
air_data$population <- as.numeric(air_data$population)
air_data$type_of_stations <- as.character(air_data$type_of_stations)
air_data$who_region <- as.factor(air_data$who_region)


```

the data contains a lot of missing values, n/a so we must remove the rows that contain this as R cannot handle this. 

#So we clean the data, cleaning types_station and region as well as will will work with it later 

```{r}
clean_data <- na.omit(air_data[, c("pm25_concentration", "population", "year","type_of_stations","who_region")])


```

Now we fit the linear model 

```{r}

pollution_fit_raw <- lm(pm25_concentration ~ population + year , 
                        data = clean_data)

# View results of coefficents 
summary(pollution_fit_raw)

```
We fitted the following linear regression model:

\[
\text{PM}_{2.5,i} = \beta_0 + \beta_1 \cdot \text{Population}_i + \beta_2 \cdot \text{Year}_i + \varepsilon_i,
\]

where $\varepsilon_i \sim N(0, \sigma^2)$ is the error term.

The estimated coefficients can be interpreted as follows:

- **Intercept**: $\hat{\beta}_0 = -218.4$ ($p = 0.0455$).  
  This represents the expected $\text{PM}_{2.5}$ concentration when both population and year are equal to zero.  
  Since this situation is not realistic, the intercept is not of direct substantive interest.

- **Population**: $\hat{\beta}_1 \approx 1.86 \times 10^{-6}$ ($p < 2 \times 10^{-16$).  
  For each additional person in the population, $\text{PM}_{2.5}$ increases by approximately $0.0000019$ units.  
  In practical terms, an increase of one million people is associated with an increase of about $1.9$ units in $\text{PM}_{2.5}$.  
  This effect is highly statistically significant, showing that population size is strongly related to pollution levels.

- **Year**: $\hat{\beta}_2 \approx 0.118$ ($p = 0.0288$).  
  Holding population constant, each additional year is associated with an increase of about $0.12$ units in $\text{PM}_{2.5}$.  
  This suggests a slight upward trend in pollution over time across the dataset.

- **Model fit**: The coefficient of determination is $R^2 \approx 0.051$.  
  This means that the model explains only around 5\% of the variation in $\text{PM}_{2.5}$ concentrations.  
  While population and year are statistically significant predictors, much of the variability remains unexplained, indicating that additional covariates (such as type of station, country, or geographic factors) would be needed to improve the model.
  
  Thus, we can see that important predictors are missing. Our next step is to try and and tidy up the predictor type_of_stations so we can include it in our analysis. 
  
  To resolve this issue of multiple location types for one city, we need to force each observation into one category. 
  As an attempt to do this, I am going to quantify station type by giving it a numeric "population density score", then avergaing if a city has multiple categories. 

We could use the following rankings 
```{r}
# Define ranking system
rankings <- c("Urban" = 5, "Traffic" = 4, "Suburban" = 3, "Background" = 2, "Rural" = 1)

# Function to compute average rank per row
get_rank <- function(x) {
  if (is.na(x)) return(NA)
  types <- strsplit(x, ",")[[1]]
  types <- trimws(types)  # remove spaces
  mean(rankings[types], na.rm = TRUE)
}
```

Then we apply this to our data set and fit the new model 

```{r}

#apply ranking
clean_data$station_rank <- sapply(clean_data$type_of_stations, get_rank)

# Fit model with numeric rank
fit <- lm(pm25_concentration ~ population + year + station_rank, data = clean_data)
summary(fit)

```
We fitted the following extended linear regression model including a numeric
ranking for station type:

\[
\text{PM}_{2.5,i} = \beta_0 + \beta_1 \cdot \text{Population}_i + \beta_2 \cdot \text{Year}_i + \beta_3 \cdot \text{StationRank}_i + \varepsilon_i,
\]

where $\varepsilon_i \sim N(0,\sigma^2)$.

The estimated coefficients can be interpreted as follows:

- **Station rank**: $\hat{\beta}_3 \approx 0.70$ ($p < 10^{-12}$).  
  Moving one step up in the ranking (e.g. from Rural to Suburban, or Suburban to Urban)  
  is associated with an increase of about $0.70$ units in PM$_{2.5}$.  
  This confirms that more urbanised stations are linked with higher pollution.

- **Model fit**: The $R^2$ is $0.068$, meaning the model explains about $7\%$ of the variance in PM$_{2.5}$.  
  This is still low, but represents an improvement compared with the simpler model (population + year only),  
  where $R^2 \approx 0.051$.  
  
  
  As of now we are assuming linearity. For example, we assume every extra person adds the same tiny increase in PM$_{2.5}$. So the difference between a city of 1 million and 2 million is treated the same as between 10 million and 11 million.In reality, pollution doesn’t usually increase in a straight line like that — very large cities often don’t keep getting proportionally dirtier forever. 
  
  So to extend our analysis, we can add some non-linear effects: 
  - By taking the log of population, we say "pollution rises quickly as cities grow from small to medium, but the effect slows down in very large cities
  
  
  
```{r}
# Create log-transformed population
clean_data$log_population <- log(clean_data$population + 1)


# Fit model with log-transformed population
fit_log <- lm(pm25_concentration ~ log_population + year + station_rank,
              data = clean_data)

# View results
summary(fit_log)
```
 ** this hasnt worked very well lol **
 
 Let us try something else - bring in regional/ country effects. 
 
 Pollution levels could be heavily shaped by geography and policy, adding a factor for country or regoin will likelu explain more variation.
 
 From our dataset we have the following standard groupings of countries:
 
 - AFR = Africa
 - AMR = Region of the Americas
 - SEAR = South- East Asia Region
 - EUR = European Region
 - EMR = Eastern Mediterranean 
 - WPR = Western Pacific Regiom
 - NonMS = Non-Member States ( countries not in WHO, often small territories)

```{r}

fit_region <- lm(pm25_concentration ~ log_population + year + station_rank + who_region,
                 data = clean_data)
summary(fit_region)

```


Including WHO region as a categorical factor improves the model fit, raising the coefficient of determination from about 7% to 11%. This confirms that geography plays an important role in explaining variation in PM$_{2.5}$ concentrations, beyond population size, year, and station type. In this specification, Africa (AFR) is treated as the baseline region. 

- **Americas (AMR)**: estimated coefficient of –5.03, not significantly different from Africa.  
- **South-East Asia (SEAR)**: coefficient of +7.12, but not statistically significant.  
- **Europe (EUR)**: coefficient of –1.35, not statistically significant.  
- **Eastern Mediterranean (EMR)**: coefficient of +18.73, statistically significant ($p = 0.004$), indicating substantially higher PM$_{2.5}$ compared to Africa.  
- **Western Pacific (WPR)**: coefficient of –0.21, not significant.  
- **Non-Member States (NonMS)**: coefficient of +1.90, not significant.  

Overall, the results suggest that while most regional effects are not statistically distinguishable from Africa, the Eastern Mediterranean Region records significantly higher levels of PM$_{2.5}$ even after accounting for population, year, and station type.

Compared with the very first baseline model, which included only population and year and explained about 5% of the variation, the addition of station rank and WHO region has roughly doubled explanatory power to 11%, highlighting the importance of including geographic and contextual factors in the analysis.

